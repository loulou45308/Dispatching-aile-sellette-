<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dispatch PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-5">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-xl">
        <h1 class="text-xl font-bold mb-4">DISPATCHING 2025</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-slate-50 p-4 rounded-xl">
            <div>
                <label class="block text-[10px] font-bold mb-1">CHARGER CSV</label>
                <input type="file" id="import1" class="mb-2 block w-full text-xs">
                <input type="file" id="import2" class="mb-2 block w-full text-xs">
                <input type="file" id="import3" class="block w-full text-xs">
            </div>
            <div class="flex flex-col gap-2 justify-end">
                <button onclick="window.viderBase()" class="bg-red-500 text-white p-2 rounded text-sm font-bold">VIDER</button>
                <button onclick="window.lancerDispatch()" class="bg-blue-600 text-white p-4 rounded text-sm font-black uppercase">LANCER DISPATCHING</button>
            </div>
        </div>

        <table class="w-full text-sm border" id="tableDispatch">
            <thead>
                <tr class="bg-slate-800 text-white uppercase text-[10px]">
                    <th class="p-2 border">Nom</th>
                    <th class="p-2 border">Poids</th>
                    <th class="p-2 border">Taille</th>
                    <th class="p-2 border bg-blue-700">Voile</th>
                    <th class="p-2 border">Sellette</th>
                </tr>
            </thead>
            <tbody id="liste-stagiaires"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, getDocs, deleteDoc, doc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBAiOJog5nwXDn8k6YTWLJA-0CxNaQUXhk",
            authDomain: "dispatching-voile-sellette.firebaseapp.com",
            projectId: "dispatching-voile-sellette",
            appId: "1:933259154090:web:ab39a667fb9f35c293b6d3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- INVENTAIRE ---
        const inventaireAiles = [
            { id: "1", ptv: [60, 80] }, { id: "3", ptv: [70, 90] }, { id: "4", ptv: [90, 110] },
            { id: "5", ptv: [90, 115] }, { id: "7", ptv: [90, 110] }, { id: "8", ptv: [75, 95] },
            { id: "14", ptv: [60, 80] }, { id: "15", ptv: [100, 130] }
        ];

        // --- IMPORTS ---
        const handleFile = (id) => {
            document.getElementById(id).addEventListener('change', (e) => {
                const reader = new FileReader();
                reader.onload = async () => {
                    const lignes = reader.result.split('\n');
                    for (let i = 8; i < lignes.length; i++) {
                        const cols = lignes[i].split(',');
                        if (cols[4] && cols[4].trim() && cols[4] !== "Nom Client") {
                            await addDoc(collection(db, "stagiaires"), {
                                nom: cols[4].trim(),
                                poids: parseFloat(cols[7]) || 0,
                                taille: parseFloat(cols[8]) || 0,
                                voile: "", sellette: ""
                            });
                        }
                    }
                    alert("Fichier chargÃ©");
                };
                reader.readAsText(e.target.files[0]);
            });
        };
        ["import1", "import2", "import3"].forEach(handleFile);

        window.viderBase = async () => {
            if(!confirm("Supprimer ?")) return;
            const snap = await getDocs(collection(db, "stagiaires"));
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        };

        window.lancerDispatch = async () => {
            const snap = await getDocs(collection(db, "stagiaires"));
            let prises = [];
            const batch = writeBatch(db);
            snap.forEach(d => {
                const s = d.data();
                const ptv = (Number(s.poids) || 0) + 15;
                let v = "STOCK";
                const m = inventaireAiles.find(a => ptv >= a.ptv[0] && ptv <= a.ptv[1] && !prises.includes(a.id));
                if(m) { v = m.id; prises.push(m.id); }
                const t = s.taille < 3 ? s.taille * 100 : s.taille;
                let sel = t < 165 ? "S" : (t > 185 ? "L" : "M");
                batch.update(d.ref, { voile: v, sellette: sel });
            });
            await batch.commit();
        };

        onSnapshot(query(collection(db, "stagiaires"), orderBy("nom")), (snap) => {
            const list = document.getElementById("liste-stagiaires");
            list.innerHTML = "";
            snap.forEach(d => {
                const s = d.data();
                list.innerHTML += `<tr class="border-b"><td class="p-2 font-bold">${s.nom}</td><td class="p-2">${s.poids}</td><td class="p-2">${s.taille < 3 ? Math.round(s.taille*100) : s.taille}</td><td class="p-2 text-center text-blue-600 font-bold">${s.voile}</td><td class="p-2 text-center">${s.sellette}</td></tr>`;
            });
        });
    </script>
</body>
</html>