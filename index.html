<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispatch Matos - École de Parapente</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 font-sans">

    <div class="max-w-md mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-black text-blue-400 uppercase tracking-tighter">Dispatch Matos</h1>
            <p class="text-slate-500 text-sm italic">Prêt pour le gonflage ?</p>
        </header>

        <div class="bg-slate-800 p-5 rounded-2xl mb-8 border border-slate-700 shadow-xl">
            <label class="block text-xs font-bold text-blue-300 mb-3 uppercase tracking-widest text-center">Charger la liste des stagiaires</label>
            <input type="file" id="csvFile" accept=".csv" 
                class="block w-full text-sm text-slate-400
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-bold
                file:bg-blue-600 file:text-white
                hover:file:bg-blue-500 file:cursor-pointer">
        </div>

        <div id="liste-stagiaires" class="space-y-4">
            <div class="text-center py-10 text-slate-600 italic border-2 border-dashed border-slate-800 rounded-2xl">
                En attente du fichier CSV...
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBAiOJog5nwXDn8k6YTWLJA-0CxNaQUXhk",
            authDomain: "dispatching-voile-sellette.firebaseapp.com",
            projectId: "dispatching-voile-sellette",
            storageBucket: "dispatching-voile-sellette.appspot.com",
            appId: "1:933259154090:web:ab39a667fb9f35c293b6d3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LECTURE DU FICHIER CSV ---
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function() {
                const lignes = reader.result.split('\n');
                
                lignes.forEach((ligne, index) => {
                    const colonnes = ligne.split(','); // Remplace par ';' si ça ne marche pas
                    
                    // On filtre pour ne prendre que les lignes avec un nom (colonne index 4)
                    if (index > 6 && colonnes[4] && colonnes[4].trim() !== "" && colonnes[4] !== "Nom Client") {
                        addDoc(collection(db, "stagiaires"), {
                            nom: colonnes[4].trim(),
                            poids: parseFloat(colonnes[7]) || 0,
                            taille: parseFloat(colonnes[8]) || 0,
                            timestamp: Date.now()
                        });
                    }
                });
                alert("Stagiaires ajoutés à la base !");
            };
            reader.readAsText(e.target.files[0]);
        });

        // --- AFFICHAGE EN DIRECT ---
        const q = query(collection(db, "stagiaires"), orderBy("nom", "asc"));
        onSnapshot(q, (snapshot) => {
            const liste = document.getElementById("liste-stagiaires");
            liste.innerHTML = "";
            
            snapshot.forEach((doc) => {
                const s = doc.data();
                const ptv = (Number(s.poids) || 0) + 15;
                const tailleCM = s.taille < 3 ? Math.round(s.taille * 100) : s.taille;

                // Logique Voile (Basé sur PTV)
                let aile = "L"; 
                if (ptv < 80) aile = "S";
                else if (ptv <= 100) aile = "M";

                // Logique Sellette (Basé sur Taille)
                let sellette = "M";
                if (tailleCM < 170) sellette = "S";
                else if (tailleCM > 185) sellette = "L";

                liste.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border-b-4 border-blue-500">
                        <div class="p-4 flex justify-between items-center text-slate-900">
                            <div>
                                <h3 class="text-xl font-black uppercase leading-none">${s.nom}</h3>
                                <p class="text-slate-400 text-xs font-bold mt-1">${tailleCM} CM / ${s.poids} KG</p>
                            </div>
                            <div class="text-right">
                                <span class="block text-2xl font-black text-blue-600 leading-none">${ptv}</span>
                                <span class="text-[10px] font-bold text-slate-400 uppercase italic">PTV Estimé</span>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-3 flex gap-2 border-t border-slate-100">
                            <div class="flex-1 bg-blue-600 text-white text-center py-2 rounded-lg">
                                <span class="block text-[10px] opacity-70 font-bold uppercase">Voile conseillée</span>
                                <span class="text-lg font-black">${aile}</span>
                            </div>
                            <div class="flex-1 bg-slate-800 text-white text-center py-2 rounded-lg">
                                <span class="block text-[10px] opacity-70 font-bold uppercase">Sellette</span>
                                <span class="text-lg font-black">${sellette}</span>
                            </div>
                        </div>
                    </div>`;
            });
        });
    </script>
</body>
</html>